name: CoreTrace Analysis (Action Tag)

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  stack-analysis:
    name: Stack Analysis (Action @v0.1.2)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt', 'src/**', 'include/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      - name: Configure project (compile_commands.json)
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run CoreTrace analyzer via pinned action tag
        id: coretrace
        uses: CoreTrace/coretrace-stack-analyzer@v0.1.2
        with:
          compile-commands: build/compile_commands.json
          analysis-profile: fast
          resource-model: default
          resource-cache-memory-only: "true"
          fail-on: error
          warnings-only: "false"
          json-file: artifacts/coretrace-stack-analysis-action.json
          sarif-file: artifacts/coretrace-stack-analysis-action.sarif
          upload-sarif: "false"

      - name: Upload SARIF to Code Scanning
        if: ${{ always() && hashFiles('artifacts/coretrace-stack-analysis-action.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: artifacts/coretrace-stack-analysis-action.sarif
          category: coretrace-consumer-action-tag

      - name: Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coretrace-results-action-tag
          path: artifacts/
          retention-days: 14

      - name: Print summary
        if: always()
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          summary_path = os.environ['GITHUB_STEP_SUMMARY']
          json_path = Path('artifacts/coretrace-stack-analysis-action.json')

          errors = warnings = infos = 0
          notes = []

          if json_path.is_file():
            try:
              data = json.loads(json_path.read_text(encoding='utf-8'))
              diags = data.get('diagnostics', []) if isinstance(data, dict) else []
            except Exception as exc:
              diags = []
              notes.append(f'Failed to parse JSON report: {exc}')

            def sev(d):
              s = str(d.get('severity', d.get('level', d.get('details', {}).get('severity', '')))).upper()
              if s in {'2', 'ERROR'}:
                return 'ERROR'
              if s in {'1', 'WARNING', 'WARN'}:
                return 'WARNING'
              return 'INFO'

            errors = sum(1 for d in diags if sev(d) == 'ERROR')
            warnings = sum(1 for d in diags if sev(d) == 'WARNING')
            infos = sum(1 for d in diags if sev(d) == 'INFO')
          else:
            notes.append('JSON report not found (analysis step may have failed early).')

          print(f'errors={errors}')
          print(f'warnings={warnings}')
          print(f'infos={infos}')

          with open(summary_path, 'a', encoding='utf-8') as f:
            f.write('## CoreTrace Analysis Summary (Action Tag)\n\n')
            f.write('| Errors | Warnings | Info |\n')
            f.write('|--------|----------|------|\n')
            f.write(f'| {errors} | {warnings} | {infos} |\n\n')
            if notes:
              f.write('### Notes\n')
              for note in notes:
                f.write(f'- {note}\n')
          PY
