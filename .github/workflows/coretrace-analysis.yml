name: CoreTrace Analysis

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CORETRACE_IMAGE: ghcr.io/coretrace/coretrace-stack-analyzer-ci:latest

jobs:
  stack-analysis:
    name: Stack Analysis (GHCR)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt', 'src/**', 'include/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      - name: Configure project (compile_commands.json)
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Pull CoreTrace CI image
        run: |
          docker pull "${CORETRACE_IMAGE}"

      - name: Run CoreTrace analyzer via GHCR image
        run: |
          mkdir -p artifacts
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE}" \
            -w "${GITHUB_WORKSPACE}" \
            "${CORETRACE_IMAGE}" \
            --compdb "${GITHUB_WORKSPACE}/build/compile_commands.json" \
            --json-out "${GITHUB_WORKSPACE}/artifacts/coretrace-stack-analysis.json" \
            --sarif-out "${GITHUB_WORKSPACE}/artifacts/coretrace-stack-analysis.sarif" \
            --base-dir "${GITHUB_WORKSPACE}" \
            --fail-on error \
            --analyzer-arg=--analysis-profile=fast \
            --analyzer-arg=--resource-summary-cache-memory-only \
            --analyzer-arg=--resource-model=/models/resource-lifetime/generic.txt

      - name: Upload SARIF to Code Scanning
        if: ${{ always() && hashFiles('artifacts/coretrace-stack-analysis.sarif') != '' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: artifacts/coretrace-stack-analysis.sarif
          category: coretrace-consumer

      - name: Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coretrace-results
          path: artifacts/
          retention-days: 14

      - name: Print summary
        if: always()
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          summary_path = os.environ['GITHUB_STEP_SUMMARY']
          json_path = Path('artifacts/coretrace-stack-analysis.json')

          errors = warnings = infos = 0
          notes = []

          if json_path.is_file():
            try:
              data = json.loads(json_path.read_text(encoding='utf-8'))
              diags = data.get('diagnostics', []) if isinstance(data, dict) else []
            except Exception as exc:
              diags = []
              notes.append(f'Failed to parse JSON report: {exc}')

            def sev(d):
              s = str(d.get('severity', d.get('level', d.get('details', {}).get('severity', '')))).upper()
              if s in {'2', 'ERROR'}:
                return 'ERROR'
              if s in {'1', 'WARNING', 'WARN'}:
                return 'WARNING'
              return 'INFO'

            errors = sum(1 for d in diags if sev(d) == 'ERROR')
            warnings = sum(1 for d in diags if sev(d) == 'WARNING')
            infos = sum(1 for d in diags if sev(d) == 'INFO')
          else:
            notes.append('JSON report not found (analysis step may have failed early).')

          print(f'errors={errors}')
          print(f'warnings={warnings}')
          print(f'infos={infos}')

          with open(summary_path, 'a', encoding='utf-8') as f:
            f.write('## CoreTrace Analysis Summary\n\n')
            f.write('| Errors | Warnings | Info |\n')
            f.write('|--------|----------|------|\n')
            f.write(f'| {errors} | {warnings} | {infos} |\n\n')
            if notes:
              f.write('### Notes\n')
              for note in notes:
                f.write(f'- {note}\n')
          PY
