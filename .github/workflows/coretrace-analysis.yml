name: CoreTrace Analysis

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CORETRACE_IMAGE: ghcr.io/coretrace/coretrace-stack-analyzer-ci:latest

jobs:
  stack-analysis:
    name: Stack Analysis (GHCR)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure project (compile_commands.json)
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Pull CoreTrace CI image
        run: |
          docker pull "${CORETRACE_IMAGE}"

      - name: Run CoreTrace analyzer via GHCR image
        run: |
          mkdir -p artifacts
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE}" \
            -w "${GITHUB_WORKSPACE}" \
            "${CORETRACE_IMAGE}" \
            --compdb "${GITHUB_WORKSPACE}/build/compile_commands.json" \
            --json-out "${GITHUB_WORKSPACE}/artifacts/coretrace-stack-analysis.json" \
            --sarif-out "${GITHUB_WORKSPACE}/artifacts/coretrace-stack-analysis.sarif" \
            --base-dir "${GITHUB_WORKSPACE}" \
            --fail-on error \
            --analyzer-arg=--analysis-profile=fast \
            --analyzer-arg=--resource-summary-cache-memory-only \
            --analyzer-arg=--resource-model=/models/resource-lifetime/generic.txt

      - name: Upload SARIF to Code Scanning
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: artifacts/coretrace-stack-analysis.sarif
          category: coretrace-consumer

      - name: Print summary
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          p = Path('artifacts/coretrace-stack-analysis.json')
          data = json.loads(p.read_text(encoding='utf-8'))
          diags = data.get('diagnostics', [])

          def sev(d):
            s = str(d.get('severity', d.get('level', d.get('details', {}).get('severity', '')))).upper()
            if s in {'2', 'ERROR'}:
              return 'ERROR'
            if s in {'1', 'WARNING', 'WARN'}:
              return 'WARNING'
            return 'INFO'

          errors = sum(1 for d in diags if sev(d) == 'ERROR')
          warnings = sum(1 for d in diags if sev(d) == 'WARNING')
          infos = sum(1 for d in diags if sev(d) == 'INFO')
          print(f'errors={errors}')
          print(f'warnings={warnings}')
          print(f'infos={infos}')
          PY
